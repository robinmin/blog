---
import { Icon } from "astro-icon/components";
import Container from "@/components/container.astro";
import LanguageSwitcher from "@/components/LanguageSwitcher.astro";
import Themeswitch from "@/components/themeswitch.astro";
import { SITE } from "@/config";

import {
	getCategoryLabel,
	getLangFromUrl,
	LANGUAGES,
	useTranslations,
} from "@/config/i18n";
import { categories } from "@/data/category";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Menu {
	label: string;
	href: string;
	external?: boolean;
	badge?: string;
	icon?: string;
	children?: Menu[];
}

const menu: Menu[] = [
	{
		label: t("nav.home"),
		href: lang === "en" ? "/" : `/${lang}/`,
		icon: "heroicons:home",
	},
	{
		label: "分类", // TODO: Add to dictionary if needed, or keep generic
		href: "#",
		icon: "heroicons:squares-2x2",
		children: categories.map((cat) => ({
			label: getCategoryLabel(cat.slug, lang),
			href: `/category/${cat.slug}`,
		})),
	},
	{
		label: t("nav.about"),
		href: lang === "en" ? "/about" : `/${lang}/about`,
		icon: "heroicons:user",
	},
	{
		label: t("nav.archives"), // archives vs archive? Dictionary says "archives". Navbar says "Archive".
		href: lang === "en" ? "/archive" : `/${lang}/archive`, // Navbar uses singular "/archive".
		icon: "heroicons:archive-box",
	},
];
---

<Container>
  <nav>
    <div class="flex flex-wrap items-center justify-between md:gap-10 md:flex-nowrap">
      
      <!-- Logo / Title (Left) -->
      <div class="flex items-center justify-between w-full md:w-auto">
        <a class="text-lg font-bold dark:text-white" href="/">
          {SITE.title}
        </a>

        <button
          id="menu"
          aria-label="Toggle Menu"
          class="px-2 py-1 ml-auto text-gray-500 rounded-md md:hidden focus:text-blue-500 focus:outline-none dark:text-gray-300">
          <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path class="navmenu-toggle" fill-rule="evenodd" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"></path>
            <path class="navmenu-toggle hidden" fill-rule="evenodd" clip-rule="evenodd" d="M18.278 16.864a1 1 0 0 1-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 0 1-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 0 1 1.414-1.414l4.829 4.828 4.828-4.828a1 1 0 1 1 1.414 1.414l-4.828 4.829 4.828 4.828z"></path>
          </svg>
        </button>
      </div>

      <!-- Right Menu (Desktop) -->
      <div class="flex-col items-center justify-start hidden w-full md:flex md:flex-row md:justify-end md:w-auto md:order-none md:flex-1 gap-4">
        {
          menu.map((item) => (
            item.children ? (
              <div class="relative dropdown-container">
                <button 
                  class="flex items-center px-5 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-blue-500 dropdown-button"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  {item.icon && <Icon name={item.icon} class="w-4 h-4 mr-2 pointer-events-none" />}
                  <span class="pointer-events-none">{item.label}</span>
                  <Icon name="heroicons:chevron-down" class="w-3 h-3 ml-1 pointer-events-none" />
                </button>
                <div class="absolute left-0 z-10 hidden w-48 mt-2 origin-top-right bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu">
                  <div class="py-1">
                    {item.children.map(child => (
                      <a href={child.href} class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 dropdown-item">
                        {child.label}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <a
                href={item.href}
                class="flex items-center px-5 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-blue-500">
                {item.icon && <Icon name={item.icon} class="w-4 h-4 mr-2" />}
                {item.label}
              </a>
            )
          ))
        }
        
        <!-- Language Switcher -->
        <div class="ml-4">
          <LanguageSwitcher />
        </div>

        <!-- Theme Switcher -->
        <div class="ml-4">
          <Themeswitch />
        </div>
      </div>
    </div>
    
    <!-- Mobile Menu -->
    <div class="navmenu-toggle hidden">
      <div class="flex flex-col items-center justify-start order-2 w-full md:hidden">
        {
          menu.map((item) => (
             item.children ? (
               <>
                <div class="w-full text-center px-5 py-2 text-sm font-bold text-gray-500 border-b dark:border-gray-700 mt-2">{item.label}</div>
                 {item.children.map(child => (
                    <a href={child.href} class="flex items-center px-5 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-blue-500">
                      {child.label}
                    </a>
                 ))}
               </>
             ) : (
                <a
                  href={item.href}
                  class="flex items-center px-5 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-blue-500"
                  target={item.external ? "_blank" : ""}
                  rel={item.external ? "noopener" : ""}>
                  {item.icon && <Icon name={item.icon} class="w-4 h-4 mr-2" />}
                  {item.label}
                </a>
             )
          ))
        }
         <!-- Mobile Theme Switcher -->
         <div class="mt-4 mb-4 flex items-center justify-between w-full px-5">
           <Themeswitch />
           <LanguageSwitcher />
         </div>
      </div>
    </div>
  </nav>
</Container>

<script is:inline>
  const menuButton = document.getElementById("menu");
  menuButton.addEventListener("click", () => {
    [...document.querySelectorAll(".navmenu-toggle")].forEach((Element) => {
      Element.classList.toggle("hidden");
    });
  });

  // Dropdown Logic
  const dropdownButtons = document.querySelectorAll(".dropdown-button");

  dropdownButtons.forEach((button) => {
    const container = button.closest('.dropdown-container');
    const menu = container.querySelector('.dropdown-menu');

    // Toggle on click
    button.addEventListener("click", (e) => {
      e.stopPropagation(); // Prevent document click from closing immediately
      const isHidden = menu.classList.contains("hidden");
      
      // Close all other dropdowns first (if we had multiple)
      document.querySelectorAll(".dropdown-menu").forEach(m => m.classList.add("hidden"));
      
      if (isHidden) {
        menu.classList.remove("hidden");
        button.setAttribute("aria-expanded", "true");
      } else {
        menu.classList.add("hidden");
        button.setAttribute("aria-expanded", "false");
      }
    });
  });

  // Global click to close
  document.addEventListener("click", (e) => {
    const isClickInsideDropdown = e.target.closest(".dropdown-container");
    if (!isClickInsideDropdown) {
      document.querySelectorAll(".dropdown-menu").forEach(menu => {
         menu.classList.add("hidden");
         // Find corresponding button to update aria
         const container = menu.closest('.dropdown-container');
         if(container) {
            const btn = container.querySelector('.dropdown-button');
            if(btn) btn.setAttribute("aria-expanded", "false");
         }
      });
    }
  });

  // ESC key to close
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document.querySelectorAll(".dropdown-menu").forEach(menu => {
         menu.classList.add("hidden");
         const container = menu.closest('.dropdown-container');
         if(container) {
            const btn = container.querySelector('.dropdown-button');
            if(btn) btn.setAttribute("aria-expanded", "false");
         }
      });
    }
  });

  // Close on item click
  document.querySelectorAll(".dropdown-item").forEach(item => {
    item.addEventListener("click", () => {
       item.closest(".dropdown-menu").classList.add("hidden");
    });
  });

</script>
